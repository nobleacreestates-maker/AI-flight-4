<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Complete travel planning - flights, hotels, Airbnb, and AI itineraries">
    <meta name="theme-color" content="#667eea">
    <title>AI Travel Planning Platform</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        h2 {
            color: #667eea;
            margin: 30px 0 20px 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        h3 {
            color: #764ba2;
            margin: 20px 0 15px 0;
            font-size: 1.3em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .keyword-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            margin: 5px;
        }
        
        .keyword-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
        }
        
        button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }
        
        button.primary:hover {
            transform: translateY(-2px);
        }
        
        button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .service-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .service-toggle button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            border: 3px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .service-toggle button strong {
            font-size: 16px;
            color: #333;
        }

        .service-toggle button small {
            font-size: 12px;
            color: #666;
        }

        .service-toggle button.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .service-toggle button.active strong {
            color: #667eea;
        }

        .service-toggle button:hover:not(.active) {
            border-color: #a5b4fc;
            background: #f8fafc;
        }

        .trip-toggle, .accommodation-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .trip-toggle button, .accommodation-toggle button {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
        }

        .trip-toggle button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .accommodation-toggle button.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* Nightlife section */
        .nightlife-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .nightlife-card {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border-radius: 12px;
            overflow: hidden;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .nightlife-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(30, 27, 75, 0.4);
        }

        .nightlife-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
        }

        .nightlife-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .nightlife-type {
            font-size: 13px;
            opacity: 0.8;
        }

        .nightlife-content {
            padding: 20px;
        }

        .music-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .music-tag {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .music-tag.primary {
            background: #f59e0b;
            color: #1e1b4b;
        }

        .nightlife-details {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.6;
        }

        .nightlife-footer {
            padding: 15px 20px;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nightlife-price {
            font-weight: 600;
        }

        .nightlife-rating {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .music-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #1e1b4b;
            border-radius: 12px;
        }

        .music-filter button {
            padding: 8px 16px;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .music-filter button.active,
        .music-filter button:hover {
            background: #f59e0b;
            border-color: #f59e0b;
            color: #1e1b4b;
        }
        
        .results-section {
            display: none;
            margin-top: 40px;
        }
        
        .results-section.show {
            display: block;
        }
        
        .section-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        thead.breakfast {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        thead.lunch {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        thead.dinner {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        .star-rating {
            color: #f59e0b;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stars {
            color: #f59e0b;
        }
        
        .price-pp {
            font-weight: 600;
            color: #10b981;
            font-size: 16px;
        }
        
        .meal-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .meal-type-badge.breakfast {
            background: #fef3c7;
            color: #92400e;
        }
        
        .meal-type-badge.lunch {
            background: #d1fae5;
            color: #065f46;
        }
        
        .meal-type-badge.dinner {
            background: #ede9fe;
            color: #5b21b6;
        }
        
        .flight-times {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        .flight-route {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 18px;
            border-radius: 12px;
            margin: 25px 0 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .day-header .weather-tip {
            font-size: 12px;
            font-weight: normal;
            opacity: 0.9;
        }

        .time-slot {
            display: grid;
            grid-template-columns: 100px 1fr 100px;
            gap: 15px;
            align-items: start;
            padding: 18px;
            background: white;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .time-slot:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .time-slot.early-morning {
            border-left-color: #f59e0b;
            background: linear-gradient(to right, #fffbeb 0%, white 100%);
        }

        .time-slot.morning {
            border-left-color: #10b981;
        }

        .time-slot.afternoon {
            border-left-color: #3b82f6;
        }

        .time-slot.evening {
            border-left-color: #8b5cf6;
            background: linear-gradient(to right, #f5f3ff 0%, white 100%);
        }

        .time-slot.night {
            border-left-color: #1e1b4b;
            background: linear-gradient(to right, #eef2ff 0%, white 100%);
        }

        .time-slot.alternative {
            border-left-style: dashed;
            opacity: 0.85;
        }

        .time-slot.hidden-gem {
            border-left-color: #f43f5e;
            background: linear-gradient(to right, #fff1f2 0%, white 100%);
        }

        .time-slot.optional-badge::before {
            content: "OPTIONAL";
            position: absolute;
            top: -8px;
            right: 10px;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .time-slot {
            position: relative;
        }

        .time {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        .activity-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .activity-desc {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .insider-tip {
            background: #fef3c7;
            color: #92400e;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 8px;
            display: inline-block;
        }

        .cost {
            text-align: right;
            font-weight: 600;
            color: #10b981;
            font-size: 16px;
        }

        .lunch-break-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 10px;
            padding: 15px 20px;
            margin: 15px 0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .lunch-break-card h4 {
            grid-column: 1/-1;
            color: #92400e;
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .lunch-option {
            background: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
        }

        .lunch-option strong {
            display: block;
            color: #92400e;
            margin-bottom: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .hidden-gem-card {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border-radius: 12px;
            padding: 18px;
            margin: 15px 0;
            border: 2px dashed #ec4899;
        }

        .hidden-gem-card h4 {
            color: #be185d;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .section-toggle button {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .section-toggle button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .section-toggle button:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }

        /* Flight cards improved */
        .flight-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.2s;
        }

        .flight-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
        }

        .flight-card.best-value {
            border-color: #10b981;
            background: linear-gradient(to right, #ecfdf5 0%, white 100%);
        }

        .flight-card.best-value::before {
            content: "BEST VALUE";
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 0 0 8px 8px;
            font-size: 11px;
            font-weight: 600;
            position: absolute;
            top: 0;
            left: 20px;
        }

        .flight-card {
            position: relative;
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .flight-route-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .flight-route-info .airline-logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: contain;
            background: #f8f9fa;
            padding: 5px;
        }

        .flight-times-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .flight-endpoint {
            text-align: center;
        }

        .flight-endpoint .time {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .flight-endpoint .airport {
            font-size: 14px;
            color: #666;
        }

        .flight-duration {
            text-align: center;
            color: #666;
        }

        .flight-duration .line {
            width: 80px;
            height: 2px;
            background: #667eea;
            margin: 8px auto;
            position: relative;
        }

        .flight-duration .line::after {
            content: "‚úà";
            position: absolute;
            right: -8px;
            top: -10px;
            font-size: 16px;
        }

        .must-see-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .must-see-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .must-see-card h4 {
            color: #667eea;
            margin: 0 0 10px 0;
        }

        .day-trip-card {
            background: linear-gradient(to right, #dbeafe 0%, white 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
        }
        
        .price-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 18px;
        }
        
        .book-btn {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .book-btn:hover {
            background: #5568d3;
        }
        
        .book-btn.airbnb {
            background: #ff5a5f;
        }
        
        .book-btn.airbnb:hover {
            background: #e04848;
        }
        
        /* Accommodation Cards */
        .accommodation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .accommodation-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .accommodation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .accommodation-card.airbnb-card {
            border-color: #ff5a5f;
        }
        
        .accommodation-images {
            position: relative;
            height: 200px;
            background: #f0f0f0;
            overflow: hidden;
        }
        
        .accommodation-images img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .accommodation-type-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .accommodation-type-badge.hotel {
            color: #667eea;
        }
        
        .accommodation-type-badge.airbnb {
            color: #ff5a5f;
        }
        
        .accommodation-content {
            padding: 20px;
        }
        
        .accommodation-name {
            font-weight: 600;
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }
        
        .accommodation-rating {
            color: #f59e0b;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .accommodation-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .accommodation-amenities {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .amenity {
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: #666;
        }
        
        .accommodation-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .accommodation-price {
            display: flex;
            flex-direction: column;
        }
        
        .price-per-night {
            font-weight: 600;
            color: #10b981;
            font-size: 20px;
        }
        
        .price-total {
            font-size: 12px;
            color: #666;
        }
        
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .budget-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .budget-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .budget-value {
            font-size: 28px;
            font-weight: 600;
            color: #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            border-left: 4px solid #f44;
            padding: 15px;
            border-radius: 8px;
            color: #c33;
            display: none;
            margin-top: 20px;
        }
        
        .error.show {
            display: block;
        }
        
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.2s;
            position: relative;
        }
        
        .tab.active {
            color: #667eea;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .time-slot {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px;
            }
            
            .accommodation-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úàÔ∏è AI Travel Planning Platform</h1>
        <p class="subtitle">Complete travel solution: Flights, Hotels, Airbnb & Restaurant Recommendations</p>

        <div class="form-section">
            <form id="searchForm">
                <!-- Service Type Toggle -->
                <div class="form-group full-width" style="margin-bottom:25px;">
                    <label style="margin-bottom:12px;">What would you like to plan?</label>
                    <div class="service-toggle">
                        <button type="button" class="active" data-service="full">
                            <span style="font-size:24px;">üåç</span>
                            <strong>Full Service</strong>
                            <small>Flights + Hotels + Itinerary</small>
                        </button>
                        <button type="button" data-service="itinerary">
                            <span style="font-size:24px;">üìã</span>
                            <strong>Itinerary Only</strong>
                            <small>Activities, restaurants & nightlife</small>
                        </button>
                    </div>
                </div>

                <div id="flightSection">
                    <div class="trip-toggle">
                        <button type="button" class="active" data-type="return">Round Trip</button>
                        <button type="button" data-type="oneway">One Way</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="origin">From</label>
                            <select id="origin">
                                <option value="">Select departure airport</option>
                            <optgroup label="London Airports">
                                <option value="LHR">London Heathrow (LHR)</option>
                                <option value="LGW">London Gatwick (LGW)</option>
                                <option value="STN">London Stansted (STN)</option>
                                <option value="LTN">London Luton (LTN)</option>
                                <option value="LCY">London City (LCY)</option>
                                <option value="SEN">London Southend (SEN)</option>
                            </optgroup>
                            <optgroup label="England">
                                <option value="MAN">Manchester (MAN)</option>
                                <option value="BHX">Birmingham (BHX)</option>
                                <option value="BRS">Bristol (BRS)</option>
                                <option value="NCL">Newcastle (NCL)</option>
                                <option value="LPL">Liverpool (LPL)</option>
                                <option value="LBA">Leeds Bradford (LBA)</option>
                                <option value="EMA">East Midlands (EMA)</option>
                                <option value="SOU">Southampton (SOU)</option>
                                <option value="BOH">Bournemouth (BOH)</option>
                                <option value="EXT">Exeter (EXT)</option>
                                <option value="NQY">Newquay (NQY)</option>
                            </optgroup>
                            <optgroup label="Scotland">
                                <option value="EDI">Edinburgh (EDI)</option>
                                <option value="GLA">Glasgow (GLA)</option>
                                <option value="ABZ">Aberdeen (ABZ)</option>
                                <option value="INV">Inverness (INV)</option>
                            </optgroup>
                            <optgroup label="Wales & N. Ireland">
                                <option value="CWL">Cardiff (CWL)</option>
                                <option value="BFS">Belfast (BFS)</option>
                            </optgroup>
                            <optgroup label="Channel Islands">
                                <option value="JER">Jersey (JER)</option>
                                <option value="GCI">Guernsey (GCI)</option>
                                <option value="IOM">Isle of Man (IOM)</option>
                            </optgroup>
                            <optgroup label="Europe - Major Hubs">
                                <option value="CDG">Paris CDG (CDG)</option>
                                <option value="AMS">Amsterdam (AMS)</option>
                                <option value="FRA">Frankfurt (FRA)</option>
                                <option value="MUC">Munich (MUC)</option>
                                <option value="MAD">Madrid (MAD)</option>
                                <option value="BCN">Barcelona (BCN)</option>
                                <option value="FCO">Rome (FCO)</option>
                                <option value="DUB">Dublin (DUB)</option>
                            </optgroup>
                            <optgroup label="USA - Major Hubs">
                                <option value="JFK">New York JFK (JFK)</option>
                                <option value="LAX">Los Angeles (LAX)</option>
                                <option value="ORD">Chicago O'Hare (ORD)</option>
                                <option value="DFW">Dallas (DFW)</option>
                                <option value="ATL">Atlanta (ATL)</option>
                            </optgroup>
                            <optgroup label="Middle East Hubs">
                                <option value="DXB">Dubai (DXB)</option>
                                <option value="DOH">Doha (DOH)</option>
                                <option value="AUH">Abu Dhabi (AUH)</option>
                            </optgroup>
                            <optgroup label="Asia Hubs">
                                <option value="SIN">Singapore (SIN)</option>
                                <option value="HKG">Hong Kong (HKG)</option>
                                <option value="NRT">Tokyo Narita (NRT)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="destination">To</label>
                        <select id="destination" required>
                            <option value="">Select destination</option>
                            <optgroup label="Spain">
                                <option value="BCN">Barcelona (BCN)</option>
                                <option value="MAD">Madrid (MAD)</option>
                                <option value="AGP">Malaga (AGP)</option>
                                <option value="PMI">Palma de Mallorca (PMI)</option>
                                <option value="IBZ">Ibiza (IBZ)</option>
                                <option value="ALC">Alicante (ALC)</option>
                                <option value="SVQ">Seville (SVQ)</option>
                                <option value="VLC">Valencia (VLC)</option>
                            </optgroup>
                            <optgroup label="France">
                                <option value="CDG">Paris CDG (CDG)</option>
                                <option value="ORY">Paris Orly (ORY)</option>
                                <option value="NCE">Nice (NCE)</option>
                                <option value="MRS">Marseille (MRS)</option>
                                <option value="LYS">Lyon (LYS)</option>
                            </optgroup>
                            <optgroup label="Italy">
                                <option value="FCO">Rome (FCO)</option>
                                <option value="MXP">Milan (MXP)</option>
                                <option value="VCE">Venice (VCE)</option>
                                <option value="NAP">Naples (NAP)</option>
                                <option value="FLR">Florence (FLR)</option>
                            </optgroup>
                            <optgroup label="Germany & Austria">
                                <option value="BER">Berlin (BER)</option>
                                <option value="MUC">Munich (MUC)</option>
                                <option value="FRA">Frankfurt (FRA)</option>
                                <option value="DUS">Dusseldorf (DUS)</option>
                                <option value="HAM">Hamburg (HAM)</option>
                                <option value="CGN">Cologne (CGN)</option>
                                <option value="VIE">Vienna (VIE)</option>
                                <option value="SZG">Salzburg (SZG)</option>
                            </optgroup>
                            <optgroup label="Netherlands & Belgium">
                                <option value="AMS">Amsterdam (AMS)</option>
                                <option value="BRU">Brussels (BRU)</option>
                                <option value="LUX">Luxembourg (LUX)</option>
                            </optgroup>
                            <optgroup label="Switzerland">
                                <option value="ZRH">Zurich (ZRH)</option>
                                <option value="GVA">Geneva (GVA)</option>
                            </optgroup>
                            <optgroup label="Portugal">
                                <option value="LIS">Lisbon (LIS)</option>
                                <option value="OPO">Porto (OPO)</option>
                                <option value="FAO">Faro (FAO)</option>
                            </optgroup>
                            <optgroup label="Greece">
                                <option value="ATH">Athens (ATH)</option>
                                <option value="SKG">Thessaloniki (SKG)</option>
                                <option value="JTR">Santorini (JTR)</option>
                                <option value="CFU">Corfu (CFU)</option>
                                <option value="HER">Heraklion/Crete (HER)</option>
                            </optgroup>
                            <optgroup label="Central Europe">
                                <option value="PRG">Prague (PRG)</option>
                                <option value="BUD">Budapest (BUD)</option>
                                <option value="WAW">Warsaw (WAW)</option>
                                <option value="KRK">Krakow (KRK)</option>
                            </optgroup>
                            <optgroup label="Scandinavia">
                                <option value="CPH">Copenhagen (CPH)</option>
                                <option value="ARN">Stockholm (ARN)</option>
                                <option value="OSL">Oslo (OSL)</option>
                                <option value="HEL">Helsinki (HEL)</option>
                                <option value="KEF">Reykjavik (KEF)</option>
                            </optgroup>
                            <optgroup label="Balkans & Eastern Europe">
                                <option value="IST">Istanbul (IST)</option>
                                <option value="AYT">Antalya (AYT)</option>
                                <option value="DUB">Dublin (DUB)</option>
                                <option value="SOF">Sofia (SOF)</option>
                                <option value="OTP">Bucharest (OTP)</option>
                                <option value="ZAG">Zagreb (ZAG)</option>
                                <option value="SPU">Split (SPU)</option>
                                <option value="DBV">Dubrovnik (DBV)</option>
                                <option value="LJU">Ljubljana (LJU)</option>
                            </optgroup>
                            <optgroup label="USA - East Coast">
                                <option value="JFK">New York JFK (JFK)</option>
                                <option value="EWR">Newark (EWR)</option>
                                <option value="BOS">Boston (BOS)</option>
                                <option value="PHL">Philadelphia (PHL)</option>
                                <option value="IAD">Washington DC (IAD)</option>
                                <option value="MIA">Miami (MIA)</option>
                                <option value="FLL">Fort Lauderdale (FLL)</option>
                                <option value="MCO">Orlando (MCO)</option>
                                <option value="TPA">Tampa (TPA)</option>
                                <option value="ATL">Atlanta (ATL)</option>
                                <option value="CLT">Charlotte (CLT)</option>
                            </optgroup>
                            <optgroup label="USA - West Coast">
                                <option value="LAX">Los Angeles (LAX)</option>
                                <option value="SFO">San Francisco (SFO)</option>
                                <option value="SAN">San Diego (SAN)</option>
                                <option value="SEA">Seattle (SEA)</option>
                                <option value="PDX">Portland (PDX)</option>
                                <option value="LAS">Las Vegas (LAS)</option>
                                <option value="PHX">Phoenix (PHX)</option>
                                <option value="HNL">Honolulu (HNL)</option>
                            </optgroup>
                            <optgroup label="USA - Central">
                                <option value="ORD">Chicago (ORD)</option>
                                <option value="DFW">Dallas (DFW)</option>
                                <option value="IAH">Houston (IAH)</option>
                                <option value="DEN">Denver (DEN)</option>
                                <option value="MSP">Minneapolis (MSP)</option>
                                <option value="DTW">Detroit (DTW)</option>
                            </optgroup>
                            <optgroup label="Canada">
                                <option value="YYZ">Toronto (YYZ)</option>
                                <option value="YVR">Vancouver (YVR)</option>
                                <option value="YUL">Montreal (YUL)</option>
                                <option value="YYC">Calgary (YYC)</option>
                            </optgroup>
                            <optgroup label="Caribbean & Mexico">
                                <option value="CUN">Cancun (CUN)</option>
                                <option value="MEX">Mexico City (MEX)</option>
                                <option value="SJU">San Juan (SJU)</option>
                                <option value="NAS">Nassau (NAS)</option>
                                <option value="MBJ">Montego Bay (MBJ)</option>
                                <option value="PUJ">Punta Cana (PUJ)</option>
                                <option value="AUA">Aruba (AUA)</option>
                            </optgroup>
                            <optgroup label="Central & South America">
                                <option value="PTY">Panama City (PTY)</option>
                                <option value="SJO">San Jose CR (SJO)</option>
                                <option value="GRU">Sao Paulo (GRU)</option>
                                <option value="GIG">Rio de Janeiro (GIG)</option>
                                <option value="EZE">Buenos Aires (EZE)</option>
                                <option value="SCL">Santiago (SCL)</option>
                                <option value="BOG">Bogota (BOG)</option>
                                <option value="LIM">Lima (LIM)</option>
                            </optgroup>
                            <optgroup label="Middle East">
                                <option value="DXB">Dubai (DXB)</option>
                                <option value="AUH">Abu Dhabi (AUH)</option>
                                <option value="DOH">Doha (DOH)</option>
                                <option value="TLV">Tel Aviv (TLV)</option>
                                <option value="CAI">Cairo (CAI)</option>
                                <option value="SSH">Sharm El Sheikh (SSH)</option>
                                <option value="HRG">Hurghada (HRG)</option>
                                <option value="RUH">Riyadh (RUH)</option>
                                <option value="JED">Jeddah (JED)</option>
                                <option value="MCT">Muscat (MCT)</option>
                                <option value="BAH">Bahrain (BAH)</option>
                                <option value="KWI">Kuwait (KWI)</option>
                            </optgroup>
                            <optgroup label="Asia - East">
                                <option value="NRT">Tokyo Narita (NRT)</option>
                                <option value="HND">Tokyo Haneda (HND)</option>
                                <option value="KIX">Osaka (KIX)</option>
                                <option value="ICN">Seoul (ICN)</option>
                                <option value="HKG">Hong Kong (HKG)</option>
                                <option value="PEK">Beijing (PEK)</option>
                                <option value="PVG">Shanghai (PVG)</option>
                                <option value="TPE">Taipei (TPE)</option>
                            </optgroup>
                            <optgroup label="Asia - Southeast">
                                <option value="BKK">Bangkok (BKK)</option>
                                <option value="HKT">Phuket (HKT)</option>
                                <option value="SIN">Singapore (SIN)</option>
                                <option value="KUL">Kuala Lumpur (KUL)</option>
                                <option value="DPS">Bali (DPS)</option>
                                <option value="MNL">Manila (MNL)</option>
                                <option value="SGN">Ho Chi Minh City (SGN)</option>
                                <option value="HAN">Hanoi (HAN)</option>
                            </optgroup>
                            <optgroup label="Asia - South">
                                <option value="DEL">New Delhi (DEL)</option>
                                <option value="BOM">Mumbai (BOM)</option>
                                <option value="BLR">Bangalore (BLR)</option>
                                <option value="CMB">Colombo (CMB)</option>
                                <option value="MLE">Maldives (MLE)</option>
                                <option value="KTM">Kathmandu (KTM)</option>
                            </optgroup>
                            <optgroup label="Africa">
                                <option value="JNB">Johannesburg (JNB)</option>
                                <option value="CPT">Cape Town (CPT)</option>
                                <option value="NBO">Nairobi (NBO)</option>
                                <option value="CMN">Casablanca (CMN)</option>
                                <option value="RAK">Marrakech (RAK)</option>
                                <option value="TUN">Tunis (TUN)</option>
                                <option value="MRU">Mauritius (MRU)</option>
                                <option value="SEZ">Seychelles (SEZ)</option>
                            </optgroup>
                            <optgroup label="Australia & Pacific">
                                <option value="SYD">Sydney (SYD)</option>
                                <option value="MEL">Melbourne (MEL)</option>
                                <option value="BNE">Brisbane (BNE)</option>
                                <option value="PER">Perth (PER)</option>
                                <option value="AKL">Auckland (AKL)</option>
                                <option value="CHC">Christchurch (CHC)</option>
                                <option value="NAN">Fiji (NAN)</option>
                            </optgroup>
                            <optgroup label="UK (Domestic)">
                                <option value="EDI">Edinburgh (EDI)</option>
                                <option value="GLA">Glasgow (GLA)</option>
                                <option value="BFS">Belfast (BFS)</option>
                                <option value="MAN">Manchester (MAN)</option>
                                <option value="JER">Jersey (JER)</option>
                                <option value="INV">Inverness (INV)</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                    <div class="form-row">
                        <div class="form-group">
                            <label for="outboundDate">Departure Date</label>
                            <input type="date" id="outboundDate" required>
                        </div>

                        <div class="form-group" id="returnDateGroup">
                            <label for="returnDate">Return Date</label>
                            <input type="date" id="returnDate" required>
                        </div>
                    </div>
                </div><!-- End flightSection -->

                <!-- Itinerary Only Destination (shown when service=itinerary) -->
                <div id="itineraryOnlySection" style="display:none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itineraryDestination">Destination City</label>
                            <select id="itineraryDestination">
                                <option value="">Select destination</option>
                                <optgroup label="Popular Europe">
                                    <option value="BCN">Barcelona</option>
                                    <option value="MAD">Madrid</option>
                                    <option value="CDG">Paris</option>
                                    <option value="FCO">Rome</option>
                                    <option value="AMS">Amsterdam</option>
                                    <option value="BER">Berlin</option>
                                    <option value="LIS">Lisbon</option>
                                    <option value="PRG">Prague</option>
                                    <option value="VIE">Vienna</option>
                                    <option value="ATH">Athens</option>
                                    <option value="DUB">Dublin</option>
                                    <option value="CPH">Copenhagen</option>
                                </optgroup>
                                <optgroup label="USA">
                                    <option value="JFK">New York</option>
                                    <option value="LAX">Los Angeles</option>
                                    <option value="MIA">Miami</option>
                                    <option value="SFO">San Francisco</option>
                                    <option value="LAS">Las Vegas</option>
                                    <option value="ORD">Chicago</option>
                                </optgroup>
                                <optgroup label="Asia">
                                    <option value="NRT">Tokyo</option>
                                    <option value="BKK">Bangkok</option>
                                    <option value="SIN">Singapore</option>
                                    <option value="HKG">Hong Kong</option>
                                    <option value="DPS">Bali</option>
                                </optgroup>
                                <optgroup label="Middle East & Africa">
                                    <option value="DXB">Dubai</option>
                                    <option value="RAK">Marrakech</option>
                                    <option value="CPT">Cape Town</option>
                                </optgroup>
                                <optgroup label="UK">
                                    <option value="LHR">London</option>
                                    <option value="EDI">Edinburgh</option>
                                    <option value="MAN">Manchester</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="itineraryDuration">Trip Duration</label>
                            <select id="itineraryDuration">
                                <option value="2">2 Days (Weekend)</option>
                                <option value="3">3 Days</option>
                                <option value="4">4 Days</option>
                                <option value="5" selected>5 Days</option>
                                <option value="7">7 Days (1 Week)</option>
                                <option value="10">10 Days</option>
                                <option value="14">14 Days (2 Weeks)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itineraryStartDate">Start Date</label>
                            <input type="date" id="itineraryStartDate">
                        </div>
                        <div class="form-group">
                            <label for="dailyBudget">Daily Budget (¬£)</label>
                            <input type="number" id="dailyBudget" value="100" min="20" step="10">
                        </div>
                    </div>
                </div>

                <div id="accommodationSection">
                    <div class="form-group full-width">
                        <label for="accommodationType">Accommodation Preference</label>
                        <div class="accommodation-toggle">
                            <button type="button" class="active" data-type="hotel">üè® Hotels Only</button>
                            <button type="button" data-type="airbnb">üè† Airbnb Only</button>
                            <button type="button" data-type="mixed">üîÑ Show Both</button>
                        </div>
                    </div>
                </div>

                <div class="form-row-3">
                    <div class="form-group" id="budgetGroup">
                        <label for="budget">Total Budget (¬£)</label>
                        <input type="number" id="budget" value="1000" min="100" step="50" required>
                    </div>

                    <div class="form-group">
                        <label for="tripType">Trip Type</label>
                        <select id="tripType">
                            <option value="leisure">Leisure</option>
                            <option value="business">Business</option>
                            <option value="adventure">Adventure</option>
                            <option value="romantic">Romantic</option>
                            <option value="family">Family</option>
                            <option value="nightlife">Nightlife & Party</option>
                            <option value="cultural">Cultural & Historic</option>
                            <option value="foodie">Food & Culinary</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="travelers">Travelers</label>
                        <select id="travelers">
                            <option value="1">1 Person</option>
                            <option value="2" selected>2 People</option>
                            <option value="3">3 People</option>
                            <option value="4">4 People</option>
                            <option value="5+">5+ People</option>
                        </select>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="keywordInput">Interests & Keywords</label>
                    <div id="keywordTags"></div>
                    <input type="text" id="keywordInput" placeholder="Type and press Enter (e.g., food, museums, nightlife, techno, jazz)">
                </div>

                <button type="submit" class="primary" id="submitBtn">
                    üöÄ Search Flights & Accommodations + Generate Itinerary
                </button>
            </form>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="font-size: 18px; margin-bottom: 10px;">Creating your complete travel plan...</p>
            <p style="color: #666; font-size: 14px;">Searching flights, hotels, Airbnb, restaurants & generating itinerary (20-40 seconds)</p>
        </div>
        
        <div class="results-section" id="results">
            <!-- Budget Summary -->
            <div class="section-card">
                <h2>üí∞ Budget Overview</h2>
                <div class="budget-grid" id="budgetGrid"></div>
            </div>
            
            <!-- Flights -->
            <div class="section-card">
                <h2>‚úàÔ∏è Best Flight Options</h2>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px;">
                    <div class="section-toggle" id="flightSortToggle">
                        <button class="active" onclick="sortFlights('price', this)">üí∞ Cheapest First</button>
                        <button onclick="sortFlights('duration', this)">‚è±Ô∏è Fastest First</button>
                        <button onclick="sortFlights('departure', this)">üåÖ Earliest Departure</button>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <label style="font-size:13px;color:#666;">Show:</label>
                        <select id="flightFilterCount" onchange="filterFlightCount()" style="padding:8px 12px;border-radius:8px;border:2px solid #e0e0e0;">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="20">Top 20</option>
                            <option value="all">Show All</option>
                        </select>
                    </div>
                </div>
                <div id="flightStats" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:15px;margin-bottom:20px;"></div>
                <div id="flightsContainer"></div>
            </div>
            
            <!-- Accommodations -->
            <div class="section-card">
                <h2 id="accommodationHeader">üè® Accommodations</h2>
                
                <div class="tab-container" id="accommodationTabs" style="display:none;">
                    <button class="tab active" data-tab="hotels">Hotels</button>
                    <button class="tab" data-tab="airbnb">Airbnb</button>
                </div>
                
                <div class="tab-content active" id="hotelsTab">
                    <div class="accommodation-grid" id="hotelsList"></div>
                </div>
                
                <div class="tab-content" id="airbnbTab">
                    <div class="accommodation-grid" id="airbnbList"></div>
                </div>
            </div>
            
            <!-- Restaurant Recommendations -->
            <div class="section-card" id="restaurantsSection">
                <h2>üçΩÔ∏è Restaurant Recommendations</h2>

                <div class="tab-container" id="restaurantTabs">
                    <button class="tab active" onclick="showRestaurantTab('meals', this)">üç¥ Meals</button>
                    <button class="tab" onclick="showRestaurantTab('street', this)">ü•° Street Food</button>
                    <button class="tab" onclick="showRestaurantTab('cafes', this)">‚òï Caf√©s & Bars</button>
                </div>

                <div id="mealsTab" class="restaurant-tab-content">
                    <h3 style="color:#d97706;">‚òï Breakfast Spots</h3>
                    <table id="breakfastTable">
                        <thead class="breakfast">
                            <tr>
                                <th>Restaurant</th>
                                <th>Cuisine</th>
                                <th>Rating</th>
                                <th>Avg Price PP</th>
                                <th>Signature Dish</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="breakfastList"></tbody>
                    </table>

                    <h3 style="color:#059669;">ü•ó Lunch Options</h3>
                    <table id="lunchTable">
                        <thead class="lunch">
                            <tr>
                                <th>Restaurant</th>
                                <th>Cuisine</th>
                                <th>Rating</th>
                                <th>Avg Price PP</th>
                                <th>Signature Dish</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="lunchList"></tbody>
                    </table>

                    <h3 style="color:#7c3aed;">üç∑ Dinner Restaurants</h3>
                    <table id="dinnerTable">
                        <thead class="dinner">
                            <tr>
                                <th>Restaurant</th>
                                <th>Cuisine</th>
                                <th>Rating</th>
                                <th>Avg Price PP</th>
                                <th>Signature Dish</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="dinnerList"></tbody>
                    </table>
                </div>

                <div id="streetTab" class="restaurant-tab-content" style="display:none;">
                    <h3 style="color:#ef4444;">ü•° Street Food & Markets</h3>
                    <div class="accommodation-grid" id="streetFoodList"></div>
                </div>

                <div id="cafesTab" class="restaurant-tab-content" style="display:none;">
                    <h3 style="color:#8b5cf6;">‚òï Caf√©s & Bars</h3>
                    <div class="accommodation-grid" id="cafesBarsList"></div>
                </div>
            </div>

            <!-- Nightlife Section -->
            <div class="section-card" id="nightlifeSection">
                <h2>üéâ Nightlife & Clubs</h2>

                <div class="music-filter" id="musicFilter">
                    <button class="active" onclick="filterNightlife('all', this)">üéµ All</button>
                    <button onclick="filterNightlife('electronic', this)">üéß Electronic/House</button>
                    <button onclick="filterNightlife('techno', this)">üíÄ Techno</button>
                    <button onclick="filterNightlife('hiphop', this)">üé§ Hip-Hop/R&B</button>
                    <button onclick="filterNightlife('latin', this)">üíÉ Latin/Reggaeton</button>
                    <button onclick="filterNightlife('rock', this)">üé∏ Rock/Indie</button>
                    <button onclick="filterNightlife('jazz', this)">üé∑ Jazz/Blues</button>
                    <button onclick="filterNightlife('mixed', this)">üé∂ Mixed/Commercial</button>
                    <button onclick="filterNightlife('rooftop', this)">üåÉ Rooftop/Lounge</button>
                </div>

                <div class="nightlife-grid" id="nightlifeList"></div>
            </div>

            <!-- Daily Itinerary -->
            <div class="section-card">
                <h2>üóìÔ∏è Day-by-Day Itinerary</h2>
                <div id="overview"></div>
                <div id="dailyItinerary"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin;

        // Service type toggle (Full Service vs Itinerary Only)
        let serviceType = 'full';
        document.querySelectorAll('.service-toggle button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.service-toggle button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                serviceType = e.target.dataset.service;

                const flightSection = document.getElementById('flightSection');
                const itineraryOnlySection = document.getElementById('itineraryOnlySection');
                const accommodationSection = document.getElementById('accommodationSection');
                const budgetGroup = document.getElementById('budgetGroup');
                const submitBtn = document.getElementById('submitBtn');
                const origin = document.getElementById('origin');
                const destination = document.getElementById('destination');
                const itineraryDestination = document.getElementById('itineraryDestination');

                if (serviceType === 'full') {
                    flightSection.style.display = 'block';
                    itineraryOnlySection.style.display = 'none';
                    accommodationSection.style.display = 'block';
                    budgetGroup.querySelector('label').textContent = 'Total Budget (¬£)';
                    submitBtn.innerHTML = 'üöÄ Search Flights & Accommodations + Generate Itinerary';
                    origin.required = true;
                    destination.required = true;
                    itineraryDestination.required = false;
                } else {
                    flightSection.style.display = 'none';
                    itineraryOnlySection.style.display = 'block';
                    accommodationSection.style.display = 'none';
                    budgetGroup.querySelector('label').textContent = 'Daily Budget (¬£)';
                    submitBtn.innerHTML = 'üìã Generate Personalized Itinerary';
                    origin.required = false;
                    destination.required = false;
                    itineraryDestination.required = true;
                }
            });
        });

        // Trip type toggle
        let tripType = 'return';
        document.querySelectorAll('.trip-toggle button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.trip-toggle button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                tripType = e.target.dataset.type;
                document.getElementById('returnDateGroup').style.display = tripType === 'return' ? 'block' : 'none';
                document.getElementById('returnDate').required = tripType === 'return';
            });
        });

        // Accommodation type toggle
        let accommodationType = 'hotel';
        document.querySelectorAll('.accommodation-toggle button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.accommodation-toggle button').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                accommodationType = e.target.dataset.type;
            });
        });

        // Nightlife data storage
        window.allNightlife = [];
        
        // Keywords
        const keywords = [];
        const keywordInput = document.getElementById('keywordInput');
        const keywordTags = document.getElementById('keywordTags');
        
        keywordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const keyword = keywordInput.value.trim();
                if (keyword && !keywords.includes(keyword)) {
                    keywords.push(keyword);
                    updateKeywordTags();
                    keywordInput.value = '';
                }
            }
        });
        
        function updateKeywordTags() {
            keywordTags.innerHTML = keywords.map((kw, i) => `
                <div class="keyword-tag">
                    ${kw}
                    <button onclick="removeKeyword(${i})">√ó</button>
                </div>
            `).join('');
        }
        
        function removeKeyword(index) {
            keywords.splice(index, 1);
            updateKeywordTags();
        }
        
        // Set default dates
        const today = new Date();
        const outbound = new Date(today);
        outbound.setDate(today.getDate() + 30);
        const returnDate = new Date(outbound);
        returnDate.setDate(outbound.getDate() + 7);

        document.getElementById('outboundDate').value = outbound.toISOString().split('T')[0];
        document.getElementById('returnDate').value = returnDate.toISOString().split('T')[0];
        document.getElementById('itineraryStartDate').value = outbound.toISOString().split('T')[0];
        
        // Default keywords
        ['food', 'culture', 'sightseeing'].forEach(kw => keywords.push(kw));
        updateKeywordTags();
        
        // Accommodation tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const targetTab = e.target.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                e.target.classList.add('active');
                document.getElementById(targetTab + 'Tab').classList.add('active');
            });
        });
        
        // Form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            document.getElementById('results').classList.remove('show');
            document.getElementById('error').classList.remove('show');
            document.getElementById('loading').classList.add('show');
            document.getElementById('submitBtn').disabled = true;

            window.scrollTo({ top: document.getElementById('loading').offsetTop - 100, behavior: 'smooth' });

            let formData;

            if (serviceType === 'full') {
                // Full service mode - flights + hotels + itinerary
                formData = {
                    service_type: 'full',
                    origin: document.getElementById('origin').value,
                    destination: document.getElementById('destination').value,
                    outbound_date: document.getElementById('outboundDate').value,
                    return_date: tripType === 'return' ? document.getElementById('returnDate').value : null,
                    budget: parseInt(document.getElementById('budget').value),
                    keywords: keywords.length > 0 ? keywords : ['general travel'],
                    accommodation_type: accommodationType,
                    trip_type: document.getElementById('tripType').value,
                    travelers: document.getElementById('travelers').value
                };
            } else {
                // Itinerary only mode
                const startDate = document.getElementById('itineraryStartDate').value;
                const duration = parseInt(document.getElementById('itineraryDuration').value);

                formData = {
                    service_type: 'itinerary_only',
                    destination: document.getElementById('itineraryDestination').value,
                    start_date: startDate,
                    duration_days: duration,
                    daily_budget: parseInt(document.getElementById('budget').value),
                    keywords: keywords.length > 0 ? keywords : ['general travel'],
                    trip_type: document.getElementById('tripType').value,
                    travelers: document.getElementById('travelers').value
                };
            }

            try {
                const response = await fetch(`${API_URL}/itinerary`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                displayResults(data, serviceType);
            } catch (error) {
                showError(`Error: ${error.message}`);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('submitBtn').disabled = false;
            }
        });
        
        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let stars = '‚≠ê'.repeat(fullStars);
            if (hasHalfStar) stars += '¬Ω';
            return stars;
        }
        
        function displayResults(data, mode = 'full') {
            // Show/hide sections based on mode
            const flightSection = document.querySelector('.section-card:has(#flightsContainer)') || document.querySelectorAll('.section-card')[1];
            const accommodationSection = document.querySelector('.section-card:has(#accommodationTabs)') || document.querySelectorAll('.section-card')[2];
            const budgetSection = document.querySelectorAll('.section-card')[0];

            // Get all section cards
            const sectionCards = document.querySelectorAll('.section-card');
            sectionCards.forEach((card, index) => {
                const header = card.querySelector('h2');
                if (header) {
                    const text = header.textContent;
                    if (text.includes('Flight') || text.includes('Accommodation')) {
                        card.style.display = mode === 'itinerary_only' ? 'none' : 'block';
                    }
                    if (text.includes('Budget')) {
                        // Update budget section based on mode
                        if (mode === 'itinerary_only') {
                            card.querySelector('h2').innerHTML = 'üí∞ Daily Budget Overview';
                        } else {
                            card.querySelector('h2').innerHTML = 'üí∞ Budget Overview';
                        }
                    }
                }
            });

            // Budget Overview
            const budgetGrid = document.getElementById('budgetGrid');
            if (mode === 'itinerary_only') {
                budgetGrid.innerHTML = `
                    <div class="budget-item">
                        <div class="budget-label">Daily Budget</div>
                        <div class="budget-value">¬£${data.daily_budget || data.total_budget}</div>
                    </div>
                    <div class="budget-item">
                        <div class="budget-label">Trip Duration</div>
                        <div class="budget-value">${data.trip_duration} days</div>
                    </div>
                    <div class="budget-item">
                        <div class="budget-label">Est. Total</div>
                        <div class="budget-value">¬£${(data.daily_budget || data.total_budget) * data.trip_duration}</div>
                    </div>
                `;
            } else {
                budgetGrid.innerHTML = `
                    <div class="budget-item">
                        <div class="budget-label">Total Budget</div>
                        <div class="budget-value">¬£${data.total_budget}</div>
                    </div>
                    <div class="budget-item">
                        <div class="budget-label">Flight Cost</div>
                        <div class="budget-value">¬£${data.recommended_flight_cost || 0}</div>
                    </div>
                    <div class="budget-item">
                        <div class="budget-label">Remaining</div>
                        <div class="budget-value">¬£${data.remaining_budget}</div>
                    </div>
                    <div class="budget-item">
                        <div class="budget-label">Trip Duration</div>
                        <div class="budget-value">${data.trip_duration} days</div>
                    </div>
                `;
            }

            // Store flights globally for sorting/filtering
            window.allFlights = data.flight_options || [];
            window.displayedFlights = [...window.allFlights];

            // Display flight statistics
            displayFlightStats(data.flight_options);

            // Display flights with new card layout
            displayFlights(data.flight_options);
            
            // Handle accommodations
            const hasHotels = data.hotel_options && data.hotel_options.length > 0;
            const hasAirbnb = data.airbnb_options && data.airbnb_options.length > 0;
            
            if (data.accommodation_type === 'mixed' && hasHotels && hasAirbnb) {
                document.getElementById('accommodationTabs').style.display = 'flex';
            } else {
                document.getElementById('accommodationTabs').style.display = 'none';
            }
            
            // Hotels
            const hotelsList = document.getElementById('hotelsList');
            if (hasHotels) {
                hotelsList.innerHTML = data.hotel_options.map(hotel => `
                    <div class="accommodation-card">
                        ${hotel.images && hotel.images.length > 0 ? `
                            <div class="accommodation-images">
                                <img src="${hotel.images[0]}" alt="${hotel.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23667eea%22 width=%22400%22 height=%22300%22/%3E%3Ctext fill=%22white%22 font-size=%2224%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3Eüè® Hotel%3C/text%3E%3C/svg%3E'">
                                <div class="accommodation-type-badge hotel">HOTEL</div>
                            </div>
                        ` : ''}
                        <div class="accommodation-content">
                            <div class="accommodation-name">${hotel.name}</div>
                            ${hotel.rating !== 'N/A' ? `
                                <div class="accommodation-rating">‚≠ê ${hotel.rating} (${hotel.reviews} reviews)</div>
                            ` : ''}
                            <p class="accommodation-desc">${hotel.description || 'Quality hotel accommodation'}</p>
                            ${hotel.amenities && hotel.amenities.length > 0 ? `
                                <div class="accommodation-amenities">
                                    ${hotel.amenities.map(a => `<span class="amenity">${a}</span>`).join('')}
                                </div>
                            ` : ''}
                            <div class="accommodation-footer">
                                <div class="accommodation-price">
                                    <div class="price-per-night">¬£${hotel.price_per_night}/night</div>
                                    ${hotel.total_price !== 'N/A' ? `
                                        <div class="price-total">Total: ¬£${hotel.total_price}</div>
                                    ` : ''}
                                </div>
                                <a href="${hotel.link}" target="_blank" class="book-btn">View Hotel ‚Üí</a>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                hotelsList.innerHTML = '<p style="color:#666;padding:20px;">No hotels found</p>';
            }
            
            // Airbnb
            const airbnbList = document.getElementById('airbnbList');
            if (hasAirbnb) {
                airbnbList.innerHTML = data.airbnb_options.map(airbnb => `
                    <div class="accommodation-card airbnb-card">
                        <div class="accommodation-images">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect fill='%23ff5a5f' width='400' height='300'/%3E%3Ctext fill='white' font-size='24' x='50%25' y='50%25' text-anchor='middle' dy='.3em'%3Eüè† Airbnb%3C/text%3E%3C/svg%3E" alt="${airbnb.name}">
                            <div class="accommodation-type-badge airbnb">AIRBNB</div>
                        </div>
                        <div class="accommodation-content">
                            <div class="accommodation-name">${airbnb.name}</div>
                            <p class="accommodation-desc">${airbnb.description || 'Airbnb accommodation'}</p>
                            ${airbnb.property_type ? `
                                <div class="accommodation-amenities">
                                    <span class="amenity">${airbnb.property_type}</span>
                                </div>
                            ` : ''}
                            <div class="accommodation-footer">
                                <div class="accommodation-price">
                                    <div class="price-per-night">¬£${airbnb.price_per_night}/night</div>
                                    <div class="price-total">Est. Total: ¬£${airbnb.total_price}</div>
                                </div>
                                <a href="${airbnb.link}" target="_blank" class="book-btn airbnb">View Listing ‚Üí</a>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                airbnbList.innerHTML = '<p style="color:#666;padding:20px;">No Airbnb listings found</p>';
            }
            
            // Restaurants - with enhanced sections
            if (data.itinerary.restaurants) {
                const restaurants = data.itinerary.restaurants;

                // Breakfast
                if (restaurants.breakfast && restaurants.breakfast.length > 0) {
                    document.getElementById('breakfastList').innerHTML = restaurants.breakfast.map(r => `
                        <tr>
                            <td>
                                <strong>${r.name}</strong>
                                <br><small style="color:#666;">${r.description || ''}</small>
                                ${r.best_for ? `<br><span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:10px;font-size:11px;">${r.best_for}</span>` : ''}
                            </td>
                            <td>${r.cuisine}</td>
                            <td><div class="star-rating"><span class="stars">${generateStars(r.rating)}</span> ${r.rating}</div></td>
                            <td><span class="price-pp">¬£${r.price_per_person}</span></td>
                            <td>${r.signature_dish || 'Various options'}</td>
                            <td>
                                <small style="color:#667eea;">üìç ${r.neighborhood || 'City center'}</small>
                                ${r.reservation_needed ? '<br><small style="color:#ef4444;">üìû Reservation recommended</small>' : ''}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('breakfastList').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">Breakfast recommendations coming soon</td></tr>';
                }

                // Lunch
                if (restaurants.lunch && restaurants.lunch.length > 0) {
                    document.getElementById('lunchList').innerHTML = restaurants.lunch.map(r => `
                        <tr>
                            <td>
                                <strong>${r.name}</strong>
                                <br><small style="color:#666;">${r.description || ''}</small>
                                ${r.best_for ? `<br><span style="background:#d1fae5;color:#065f46;padding:2px 8px;border-radius:10px;font-size:11px;">${r.best_for}</span>` : ''}
                            </td>
                            <td>${r.cuisine}</td>
                            <td><div class="star-rating"><span class="stars">${generateStars(r.rating)}</span> ${r.rating}</div></td>
                            <td><span class="price-pp">¬£${r.price_per_person}</span></td>
                            <td>${r.signature_dish || 'Various options'}</td>
                            <td>
                                <small style="color:#667eea;">üìç ${r.neighborhood || 'City center'}</small>
                                ${r.reservation_needed ? '<br><small style="color:#ef4444;">üìû Reservation recommended</small>' : ''}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('lunchList').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">Lunch recommendations coming soon</td></tr>';
                }

                // Dinner
                if (restaurants.dinner && restaurants.dinner.length > 0) {
                    document.getElementById('dinnerList').innerHTML = restaurants.dinner.map(r => `
                        <tr>
                            <td>
                                <strong>${r.name}</strong>
                                <br><small style="color:#666;">${r.description || ''}</small>
                                ${r.best_for ? `<br><span style="background:#ede9fe;color:#5b21b6;padding:2px 8px;border-radius:10px;font-size:11px;">${r.best_for}</span>` : ''}
                            </td>
                            <td>${r.cuisine}</td>
                            <td><div class="star-rating"><span class="stars">${generateStars(r.rating)}</span> ${r.rating}</div></td>
                            <td><span class="price-pp">¬£${r.price_per_person}</span></td>
                            <td>${r.signature_dish || 'Various options'}</td>
                            <td>
                                <small style="color:#667eea;">üìç ${r.neighborhood || 'City center'}</small>
                                ${r.reservation_needed ? '<br><small style="color:#ef4444;">üìû Reservation required</small>' : ''}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('dinnerList').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">Dinner recommendations coming soon</td></tr>';
                }

                // Street Food
                const streetFoodList = document.getElementById('streetFoodList');
                if (restaurants.street_food && restaurants.street_food.length > 0) {
                    streetFoodList.innerHTML = restaurants.street_food.map(sf => `
                        <div class="accommodation-card" style="border-color:#ef4444;">
                            <div style="background:linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);padding:20px;">
                                <div style="font-size:32px;margin-bottom:10px;">ü•°</div>
                                <div style="font-weight:600;font-size:18px;color:#991b1b;">${sf.name}</div>
                            </div>
                            <div class="accommodation-content">
                                <p style="color:#666;margin-bottom:10px;"><strong>Specialty:</strong> ${sf.specialty}</p>
                                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;">
                                    <span class="amenity" style="background:#dcfce7;color:#166534;">üí∞ ¬£${sf.price_range}</span>
                                    <span class="amenity" style="background:#dbeafe;color:#1e40af;">üìç ${sf.location}</span>
                                    <span class="amenity" style="background:#fef3c7;color:#92400e;">üïê ${sf.hours}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    streetFoodList.innerHTML = '<p style="color:#666;padding:20px;text-align:center;">Street food recommendations coming soon</p>';
                }

                // Caf√©s & Bars
                const cafesBarsList = document.getElementById('cafesBarsList');
                if (restaurants.cafes_bars && restaurants.cafes_bars.length > 0) {
                    cafesBarsList.innerHTML = restaurants.cafes_bars.map(cb => `
                        <div class="accommodation-card" style="border-color:#8b5cf6;">
                            <div style="background:linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);padding:20px;">
                                <div style="font-size:32px;margin-bottom:10px;">${cb.type.includes('Coffee') || cb.type.includes('Caf√©') ? '‚òï' : cb.type.includes('Wine') ? 'üç∑' : 'üç∏'}</div>
                                <div style="font-weight:600;font-size:18px;color:#5b21b6;">${cb.name}</div>
                                <div style="color:#7c3aed;font-size:13px;">${cb.type}</div>
                            </div>
                            <div class="accommodation-content">
                                <p style="color:#666;margin-bottom:10px;">${cb.vibe}</p>
                                <div style="background:#fef3c7;padding:10px;border-radius:8px;margin-bottom:15px;">
                                    <strong style="color:#92400e;">Must Try:</strong>
                                    <span style="color:#78350f;">${cb.must_try}</span>
                                </div>
                                <div style="font-size:13px;color:#667eea;">üìç ${cb.neighborhood}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    cafesBarsList.innerHTML = '<p style="color:#666;padding:20px;text-align:center;">Caf√© & bar recommendations coming soon</p>';
                }
            }

            // Nightlife Section
            if (data.itinerary && data.itinerary.nightlife) {
                displayNightlife(data.itinerary.nightlife);
                document.getElementById('nightlifeSection').style.display = 'block';
            } else {
                document.getElementById('nightlifeSection').style.display = 'none';
            }

            // Itinerary
            displayItinerary(data.itinerary);
            
            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function displayItinerary(itinerary) {
            const overview = document.getElementById('overview');
            const dailyItinerary = document.getElementById('dailyItinerary');

            // Enhanced Overview
            if (itinerary.overview) {
                overview.innerHTML = `
                    <div style="background:white;padding:25px;border-radius:12px;margin-bottom:25px;box-shadow:0 2px 10px rgba(0,0,0,0.08);">
                        <h3 style="color:#667eea;margin-bottom:20px;font-size:1.5em;">üìç ${itinerary.overview.destination || ''}</h3>

                        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:20px;">
                            ${itinerary.overview.best_time_to_visit ? `
                                <div style="background:#f0fdf4;padding:15px;border-radius:8px;border-left:4px solid #10b981;">
                                    <strong style="color:#065f46;">üå§Ô∏è Best Time to Visit</strong>
                                    <p style="margin:8px 0 0 0;color:#166534;font-size:14px;">${itinerary.overview.best_time_to_visit}</p>
                                </div>
                            ` : ''}

                            ${itinerary.overview.getting_around ? `
                                <div style="background:#eff6ff;padding:15px;border-radius:8px;border-left:4px solid #3b82f6;">
                                    <strong style="color:#1e40af;">üöá Getting Around</strong>
                                    <p style="margin:8px 0 0 0;color:#1e3a8a;font-size:14px;">${itinerary.overview.getting_around}</p>
                                </div>
                            ` : ''}

                            ${itinerary.overview.local_customs ? `
                                <div style="background:#fef3c7;padding:15px;border-radius:8px;border-left:4px solid #f59e0b;">
                                    <strong style="color:#92400e;">ü§ù Local Customs</strong>
                                    <p style="margin:8px 0 0 0;color:#78350f;font-size:14px;">${itinerary.overview.local_customs}</p>
                                </div>
                            ` : ''}

                            ${itinerary.overview.emergency_info ? `
                                <div style="background:#fef2f2;padding:15px;border-radius:8px;border-left:4px solid #ef4444;">
                                    <strong style="color:#b91c1c;">üÜò Emergency Info</strong>
                                    <p style="margin:8px 0 0 0;color:#991b1b;font-size:14px;">${itinerary.overview.emergency_info}</p>
                                </div>
                            ` : ''}
                        </div>

                        ${itinerary.overview.best_neighborhoods ? `
                            <div style="margin-top:20px;">
                                <strong style="color:#667eea;">üèòÔ∏è Best Neighborhoods:</strong>
                                <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">
                                    ${itinerary.overview.best_neighborhoods.map(n => `<span style="background:#eef2ff;color:#4338ca;padding:6px 14px;border-radius:20px;font-size:13px;">${n}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${itinerary.overview.money_saving_tips ? `
                            <div style="margin-top:20px;background:#ecfdf5;padding:15px;border-radius:8px;">
                                <strong style="color:#065f46;">üí° Money-Saving Tips:</strong>
                                <ul style="margin:10px 0 0 20px;line-height:1.8;color:#047857;">
                                    ${itinerary.overview.money_saving_tips.map(tip => `<li>${tip}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>

                    ${itinerary.must_see_attractions && itinerary.must_see_attractions.length > 0 ? `
                        <div style="background:white;padding:25px;border-radius:12px;margin-bottom:25px;box-shadow:0 2px 10px rgba(0,0,0,0.08);">
                            <h3 style="color:#667eea;margin-bottom:15px;">‚≠ê Must-See Attractions</h3>
                            <div class="must-see-grid">
                                ${itinerary.must_see_attractions.map(attr => `
                                    <div class="must-see-card">
                                        <h4>${attr.name}</h4>
                                        <p style="color:#666;margin-bottom:10px;">${attr.why}</p>
                                        <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;">
                                            <span style="background:#dbeafe;color:#1e40af;padding:4px 10px;border-radius:12px;">‚è±Ô∏è ${attr.time_needed}</span>
                                            <span style="background:#dcfce7;color:#166534;padding:4px 10px;border-radius:12px;">üïê ${attr.best_time}</span>
                                            <span style="background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:12px;">üí∞ ¬£${attr.cost}</span>
                                        </div>
                                        ${attr.skip_if ? `<p style="color:#dc2626;font-size:12px;margin-top:10px;">‚ö†Ô∏è Skip if: ${attr.skip_if}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${itinerary.day_trips && itinerary.day_trips.length > 0 ? `
                        <div style="background:white;padding:25px;border-radius:12px;margin-bottom:25px;box-shadow:0 2px 10px rgba(0,0,0,0.08);">
                            <h3 style="color:#3b82f6;margin-bottom:15px;">üöÇ Day Trip Options</h3>
                            ${itinerary.day_trips.map(trip => `
                                <div class="day-trip-card">
                                    <h4 style="color:#1e40af;margin:0 0 8px 0;">${trip.destination}</h4>
                                    <p style="color:#3b82f6;font-size:13px;margin-bottom:8px;">üìç ${trip.distance}</p>
                                    <p style="color:#666;font-size:14px;">${trip.highlights}</p>
                                    <div style="display:flex;gap:15px;margin-top:10px;font-size:13px;">
                                        <span style="color:#059669;">üí∞ Est. ¬£${trip.cost}</span>
                                        <span style="color:#7c3aed;">${trip.best_for}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            }

            // View toggle for daily itinerary
            let showAlternatives = true;
            let showOptional = true;

            // Enhanced Daily Itinerary
            if (itinerary.daily_itinerary && itinerary.daily_itinerary.length > 0) {
                dailyItinerary.innerHTML = `
                    <div class="section-toggle" style="margin-bottom:20px;">
                        <button class="active" onclick="toggleView('all', this)">Show All</button>
                        <button onclick="toggleView('main', this)">Main Activities Only</button>
                        <button onclick="toggleView('compact', this)">Compact View</button>
                    </div>
                    <div id="itineraryContent">
                    ${itinerary.daily_itinerary.map(day => `
                        <div class="day-header">
                            <span>Day ${day.day}: ${day.theme || 'Exploration'}</span>
                            ${day.weather_tip ? `<span class="weather-tip">‚òÄÔ∏è ${day.weather_tip}</span>` : ''}
                        </div>

                        ${day.early_morning ? `
                            <div class="time-slot early-morning optional-slot" ${day.early_morning.is_optional ? 'style="position:relative;"' : ''}>
                                ${day.early_morning.is_optional ? '<span style="position:absolute;top:-8px;right:10px;background:#f59e0b;color:white;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;">OPTIONAL</span>' : ''}
                                <div class="time">üåÖ ${day.early_morning.time || '7:00 AM'}</div>
                                <div>
                                    <div class="activity-name">${day.early_morning.activity}</div>
                                    <div class="activity-desc">${day.early_morning.description}</div>
                                    ${day.early_morning.location ? `<small style="color:#667eea;">üìç ${day.early_morning.location}</small>` : ''}
                                    ${day.early_morning.duration ? `<small style="color:#999;margin-left:10px;">‚è±Ô∏è ${day.early_morning.duration}</small>` : ''}
                                </div>
                                <div class="cost">${day.early_morning.cost ? `¬£${day.early_morning.cost}` : 'Free'}</div>
                            </div>
                        ` : ''}

                        ${day.morning ? `
                            <div class="time-slot morning">
                                <div class="time">‚òÄÔ∏è ${day.morning.time || 'Morning'}</div>
                                <div>
                                    <div class="activity-name">${day.morning.activity}</div>
                                    <div class="activity-desc">${day.morning.description}</div>
                                    ${day.morning.location ? `<small style="color:#667eea;">üìç ${day.morning.location}</small>` : ''}
                                    ${day.morning.duration ? `<small style="color:#999;margin-left:10px;">‚è±Ô∏è ${day.morning.duration}</small>` : ''}
                                    ${day.morning.insider_tip ? `<div class="insider-tip">üí° ${day.morning.insider_tip}</div>` : ''}
                                </div>
                                <div class="cost">¬£${day.morning.cost || 0}</div>
                            </div>
                        ` : ''}

                        ${day.morning_alternative ? `
                            <div class="time-slot morning alternative alt-slot">
                                <div class="time">üîÑ Alternative</div>
                                <div>
                                    <div class="activity-name">${day.morning_alternative.activity}</div>
                                    <div class="activity-desc">${day.morning_alternative.description}</div>
                                    ${day.morning_alternative.location ? `<small style="color:#667eea;">üìç ${day.morning_alternative.location}</small>` : ''}
                                </div>
                                <div class="cost">¬£${day.morning_alternative.cost || 0}</div>
                            </div>
                        ` : ''}

                        ${day.lunch_break ? `
                            <div class="lunch-break-card">
                                <h4>üçΩÔ∏è Lunch Break (${day.lunch_break.time || '12:30 PM'})</h4>
                                <div class="lunch-option">
                                    <strong>üìç Area</strong>
                                    ${day.lunch_break.suggested_area || 'City center'}
                                </div>
                                <div class="lunch-option">
                                    <strong>üí∞ Budget</strong>
                                    ${day.lunch_break.budget_option || 'Street food or local market'}
                                </div>
                                <div class="lunch-option">
                                    <strong>‚ú® Splurge</strong>
                                    ${day.lunch_break.splurge_option || 'Nice restaurant'}
                                </div>
                            </div>
                        ` : ''}

                        ${day.afternoon ? `
                            <div class="time-slot afternoon">
                                <div class="time">üå§Ô∏è ${day.afternoon.time || 'Afternoon'}</div>
                                <div>
                                    <div class="activity-name">${day.afternoon.activity}</div>
                                    <div class="activity-desc">${day.afternoon.description}</div>
                                    ${day.afternoon.location ? `<small style="color:#667eea;">üìç ${day.afternoon.location}</small>` : ''}
                                    ${day.afternoon.duration ? `<small style="color:#999;margin-left:10px;">‚è±Ô∏è ${day.afternoon.duration}</small>` : ''}
                                    ${day.afternoon.insider_tip ? `<div class="insider-tip">üí° ${day.afternoon.insider_tip}</div>` : ''}
                                </div>
                                <div class="cost">¬£${day.afternoon.cost || 0}</div>
                            </div>
                        ` : ''}

                        ${day.afternoon_alternative ? `
                            <div class="time-slot afternoon alternative alt-slot">
                                <div class="time">üåßÔ∏è Rainy Day</div>
                                <div>
                                    <div class="activity-name">${day.afternoon_alternative.activity}</div>
                                    <div class="activity-desc">${day.afternoon_alternative.description}</div>
                                    ${day.afternoon_alternative.location ? `<small style="color:#667eea;">üìç ${day.afternoon_alternative.location}</small>` : ''}
                                </div>
                                <div class="cost">¬£${day.afternoon_alternative.cost || 0}</div>
                            </div>
                        ` : ''}

                        ${day.evening ? `
                            <div class="time-slot evening">
                                <div class="time">üåÜ ${day.evening.time || 'Evening'}</div>
                                <div>
                                    <div class="activity-name">${day.evening.activity}</div>
                                    <div class="activity-desc">${day.evening.description}</div>
                                    ${day.evening.location ? `<small style="color:#667eea;">üìç ${day.evening.location}</small>` : ''}
                                    ${day.evening.duration ? `<small style="color:#999;margin-left:10px;">‚è±Ô∏è ${day.evening.duration}</small>` : ''}
                                </div>
                                <div class="cost">¬£${day.evening.cost || 0}</div>
                            </div>
                        ` : ''}

                        ${day.night ? `
                            <div class="time-slot night optional-slot" ${day.night.is_optional ? 'style="position:relative;"' : ''}>
                                ${day.night.is_optional ? '<span style="position:absolute;top:-8px;right:10px;background:#6366f1;color:white;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;">NIGHTLIFE</span>' : ''}
                                <div class="time">üåô ${day.night.time || '9:00 PM'}</div>
                                <div>
                                    <div class="activity-name">${day.night.activity}</div>
                                    <div class="activity-desc">${day.night.description}</div>
                                    ${day.night.location ? `<small style="color:#667eea;">üìç ${day.night.location}</small>` : ''}
                                    ${day.night.duration ? `<small style="color:#999;margin-left:10px;">‚è±Ô∏è ${day.night.duration}</small>` : ''}
                                </div>
                                <div class="cost">¬£${day.night.cost || 0}</div>
                            </div>
                        ` : ''}

                        ${day.hidden_gem ? `
                            <div class="hidden-gem-card">
                                <h4>üíé Hidden Gem</h4>
                                <div style="display:grid;grid-template-columns:1fr auto;gap:15px;">
                                    <div>
                                        <div style="font-weight:600;color:#be185d;margin-bottom:5px;">${day.hidden_gem.activity}</div>
                                        <div style="color:#666;font-size:14px;">${day.hidden_gem.description}</div>
                                        <div style="margin-top:8px;font-size:13px;">
                                            <span style="color:#be185d;">üìç ${day.hidden_gem.location}</span>
                                            ${day.hidden_gem.best_time ? `<span style="color:#6b7280;margin-left:10px;">üïê ${day.hidden_gem.best_time}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div style="text-align:right;padding:12px 18px;background:linear-gradient(to right, white, #ecfdf5);border-radius:10px;margin-top:15px;font-weight:600;display:flex;justify-content:space-between;align-items:center;">
                            <span style="color:#666;font-size:13px;">Estimated costs for main activities</span>
                            <span>Day Total: <span style="color:#10b981;font-size:20px;">¬£${day.daily_total || 0}</span></span>
                        </div>
                    `).join('')}
                    </div>
                `;
            }

            // Budget Summary Enhancement
            if (itinerary.budget_summary) {
                const bs = itinerary.budget_summary;
                const budgetHtml = `
                    <div style="background:white;padding:25px;border-radius:12px;margin-top:25px;box-shadow:0 2px 10px rgba(0,0,0,0.08);">
                        <h3 style="color:#667eea;margin-bottom:20px;">üí∞ Budget Breakdown</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:15px;margin-bottom:20px;">
                            <div style="background:#f0fdf4;padding:15px;border-radius:8px;text-align:center;">
                                <div style="color:#065f46;font-size:12px;">Activities</div>
                                <div style="color:#10b981;font-size:24px;font-weight:700;">¬£${bs.activities || 0}</div>
                            </div>
                            <div style="background:#fef3c7;padding:15px;border-radius:8px;text-align:center;">
                                <div style="color:#92400e;font-size:12px;">Food</div>
                                <div style="color:#f59e0b;font-size:24px;font-weight:700;">¬£${bs.food || 0}</div>
                            </div>
                            <div style="background:#dbeafe;padding:15px;border-radius:8px;text-align:center;">
                                <div style="color:#1e40af;font-size:12px;">Transport</div>
                                <div style="color:#3b82f6;font-size:24px;font-weight:700;">¬£${bs.transport || 0}</div>
                            </div>
                            <div style="background:#ede9fe;padding:15px;border-radius:8px;text-align:center;">
                                <div style="color:#5b21b6;font-size:12px;">Accommodation</div>
                                <div style="color:#8b5cf6;font-size:24px;font-weight:700;">¬£${bs.accommodation_estimate || 0}</div>
                            </div>
                        </div>
                        ${bs.budget_version || bs.comfort_version || bs.luxury_version ? `
                            <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-top:20px;">
                                <div style="background:#ecfdf5;padding:20px;border-radius:12px;text-align:center;border:2px solid #10b981;">
                                    <div style="color:#065f46;font-size:14px;font-weight:600;">Budget Trip</div>
                                    <div style="color:#10b981;font-size:28px;font-weight:700;margin-top:5px;">¬£${bs.budget_version || 'N/A'}</div>
                                    <div style="color:#059669;font-size:11px;margin-top:5px;">Hostels, street food, free activities</div>
                                </div>
                                <div style="background:#eef2ff;padding:20px;border-radius:12px;text-align:center;border:2px solid #667eea;">
                                    <div style="color:#3730a3;font-size:14px;font-weight:600;">Comfort Trip</div>
                                    <div style="color:#667eea;font-size:28px;font-weight:700;margin-top:5px;">¬£${bs.comfort_version || bs.total_estimate || 'N/A'}</div>
                                    <div style="color:#4f46e5;font-size:11px;margin-top:5px;">3-star hotels, nice restaurants</div>
                                </div>
                                <div style="background:#fdf4ff;padding:20px;border-radius:12px;text-align:center;border:2px solid #a855f7;">
                                    <div style="color:#7e22ce;font-size:14px;font-weight:600;">Luxury Trip</div>
                                    <div style="color:#a855f7;font-size:28px;font-weight:700;margin-top:5px;">¬£${bs.luxury_version || 'N/A'}</div>
                                    <div style="color:#9333ea;font-size:11px;margin-top:5px;">5-star hotels, fine dining, VIP</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                dailyItinerary.innerHTML += budgetHtml;
            }
        }

        function toggleView(view, btn) {
            document.querySelectorAll('.section-toggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const altSlots = document.querySelectorAll('.alt-slot');
            const optionalSlots = document.querySelectorAll('.optional-slot');
            const hiddenGems = document.querySelectorAll('.hidden-gem-card');
            const lunchBreaks = document.querySelectorAll('.lunch-break-card');

            if (view === 'all') {
                altSlots.forEach(s => s.style.display = 'grid');
                optionalSlots.forEach(s => s.style.display = 'grid');
                hiddenGems.forEach(s => s.style.display = 'block');
                lunchBreaks.forEach(s => s.style.display = 'grid');
            } else if (view === 'main') {
                altSlots.forEach(s => s.style.display = 'none');
                optionalSlots.forEach(s => s.style.display = 'none');
                hiddenGems.forEach(s => s.style.display = 'none');
                lunchBreaks.forEach(s => s.style.display = 'grid');
            } else if (view === 'compact') {
                altSlots.forEach(s => s.style.display = 'none');
                optionalSlots.forEach(s => s.style.display = 'none');
                hiddenGems.forEach(s => s.style.display = 'none');
                lunchBreaks.forEach(s => s.style.display = 'none');
            }
        }
        
        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').classList.add('show');
        }

        // Flight display and management functions
        function displayFlightStats(flights) {
            const statsContainer = document.getElementById('flightStats');
            if (!flights || flights.length === 0) {
                statsContainer.innerHTML = '';
                return;
            }

            const prices = flights.filter(f => f.price).map(f => f.price);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);

            statsContainer.innerHTML = `
                <div style="background:#ecfdf5;padding:15px;border-radius:10px;text-align:center;">
                    <div style="color:#065f46;font-size:12px;font-weight:600;">CHEAPEST</div>
                    <div style="color:#10b981;font-size:24px;font-weight:700;">¬£${minPrice}</div>
                </div>
                <div style="background:#eef2ff;padding:15px;border-radius:10px;text-align:center;">
                    <div style="color:#3730a3;font-size:12px;font-weight:600;">AVERAGE</div>
                    <div style="color:#667eea;font-size:24px;font-weight:700;">¬£${avgPrice}</div>
                </div>
                <div style="background:#fef3c7;padding:15px;border-radius:10px;text-align:center;">
                    <div style="color:#92400e;font-size:12px;font-weight:600;">MOST EXPENSIVE</div>
                    <div style="color:#f59e0b;font-size:24px;font-weight:700;">¬£${maxPrice}</div>
                </div>
                <div style="background:#f3f4f6;padding:15px;border-radius:10px;text-align:center;">
                    <div style="color:#374151;font-size:12px;font-weight:600;">TOTAL OPTIONS</div>
                    <div style="color:#6b7280;font-size:24px;font-weight:700;">${flights.length}</div>
                </div>
            `;
        }

        function displayFlights(flights) {
            const container = document.getElementById('flightsContainer');
            const filterCount = document.getElementById('flightFilterCount').value;

            let displayFlights = [...flights];
            if (filterCount !== 'all') {
                displayFlights = displayFlights.slice(0, parseInt(filterCount));
            }

            if (!displayFlights || displayFlights.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#666;">
                        <div style="font-size:48px;margin-bottom:15px;">‚úàÔ∏è</div>
                        <p>No flights found for your search criteria.</p>
                        <p style="font-size:14px;">Try adjusting your dates or destination.</p>
                    </div>
                `;
                return;
            }

            const cheapestPrice = Math.min(...flights.filter(f => f.price).map(f => f.price));

            container.innerHTML = displayFlights.map((flight, index) => {
                const isCheapest = flight.price === cheapestPrice;
                const hasReturn = flight.return_date && (flight.return_departure_time || flight.is_round_trip);
                const outboundStops = flight.outbound_stops || (flight.outbound_layovers ? flight.outbound_layovers.length : 0);
                const returnStops = flight.return_stops || (flight.return_layovers ? flight.return_layovers.length : 0);

                return `
                    <div class="flight-card ${isCheapest ? 'best-value' : ''}" style="margin-bottom:15px;">
                        <div class="flight-header">
                            <div class="flight-route-info">
                                ${flight.airline_logo ? `<img src="${flight.airline_logo}" class="airline-logo" alt="${flight.airline}" onerror="this.style.display='none'">` : ''}
                                <div>
                                    <div style="font-weight:600;font-size:18px;">${flight.airline || 'Multiple Airlines'}</div>
                                    <div style="color:#666;font-size:13px;">
                                        ${hasReturn ? '‚úàÔ∏è Round Trip' : '‚úàÔ∏è One Way'} ¬∑ ${flight.outbound_date}${hasReturn ? ` ‚Üí ${flight.return_date}` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div class="price-badge" style="font-size:22px;">¬£${flight.price || 'N/A'}</div>
                                ${isCheapest ? '<div style="color:#10b981;font-size:12px;font-weight:600;margin-top:5px;">‚úì Best Price</div>' : ''}
                                ${hasReturn ? '<div style="color:#3b82f6;font-size:11px;margin-top:3px;">Total for round trip</div>' : ''}
                            </div>
                        </div>

                        <!-- OUTBOUND FLIGHT -->
                        <div style="background:#dbeafe;padding:8px 15px;border-radius:8px 8px 0 0;margin-top:15px;">
                            <strong style="color:#1e40af;font-size:13px;">‚úàÔ∏è OUTBOUND ¬∑ ${flight.outbound_date}</strong>
                        </div>
                        <div class="flight-times-grid" style="border-radius:0 0 8px 8px;margin-top:0;">
                            <div class="flight-endpoint">
                                <div class="time">${flight.outbound_departure_time || '--:--'}</div>
                                <div class="airport">${flight.outbound_departure_airport || 'DEP'}</div>
                            </div>
                            <div class="flight-duration">
                                <div style="font-size:13px;">${formatDuration(flight.outbound_duration) || flight.total_duration || '--'}</div>
                                <div class="line"></div>
                                <div style="font-size:11px;color:#999;">
                                    ${outboundStops > 0 ? `${outboundStops} stop${outboundStops > 1 ? 's' : ''}` : 'Direct'}
                                    ${flight.outbound_layovers && flight.outbound_layovers.length > 0 ? ` (${flight.outbound_layovers.join(', ')})` : ''}
                                </div>
                            </div>
                            <div class="flight-endpoint">
                                <div class="time">${flight.outbound_arrival_time || '--:--'}</div>
                                <div class="airport">${flight.outbound_arrival_airport || 'ARR'}</div>
                            </div>
                        </div>

                        <!-- INBOUND/RETURN FLIGHT -->
                        ${hasReturn ? `
                            <div style="background:#dcfce7;padding:8px 15px;border-radius:8px 8px 0 0;margin-top:15px;">
                                <strong style="color:#166534;font-size:13px;">üîô RETURN ¬∑ ${flight.return_date}</strong>
                                ${flight.return_airline && flight.return_airline !== flight.airline ? `<span style="color:#059669;font-size:12px;margin-left:10px;">¬∑ ${flight.return_airline}</span>` : ''}
                            </div>
                            <div class="flight-times-grid" style="background:#f0fdf4;border-radius:0 0 8px 8px;margin-top:0;">
                                <div class="flight-endpoint">
                                    <div class="time">${flight.return_departure_time || '--:--'}</div>
                                    <div class="airport">${flight.return_departure_airport || flight.outbound_arrival_airport || 'DEP'}</div>
                                </div>
                                <div class="flight-duration">
                                    <div style="font-size:13px;">${formatDuration(flight.return_duration) || '--'}</div>
                                    <div class="line" style="transform:scaleX(-1);"></div>
                                    <div style="font-size:11px;color:#999;">
                                        ${returnStops > 0 ? `${returnStops} stop${returnStops > 1 ? 's' : ''}` : 'Direct'}
                                        ${flight.return_layovers && flight.return_layovers.length > 0 ? ` (${flight.return_layovers.join(', ')})` : ''}
                                    </div>
                                </div>
                                <div class="flight-endpoint">
                                    <div class="time">${flight.return_arrival_time || '--:--'}</div>
                                    <div class="airport">${flight.return_arrival_airport || flight.outbound_departure_airport || 'ARR'}</div>
                                </div>
                            </div>
                        ` : `
                            <div style="background:#fef3c7;padding:12px 15px;border-radius:8px;margin-top:15px;text-align:center;">
                                <span style="color:#92400e;font-size:13px;">‚ÑπÔ∏è One-way flight ¬∑ No return included</span>
                            </div>
                        `}

                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:15px;padding-top:15px;border-top:1px solid #e0e0e0;flex-wrap:wrap;gap:10px;">
                            <div style="display:flex;gap:15px;font-size:13px;color:#666;flex-wrap:wrap;">
                                ${flight.total_duration ? `<span>‚è±Ô∏è Total: ${flight.total_duration}</span>` : ''}
                                ${flight.flight_number ? `<span>üé´ ${flight.flight_number}</span>` : ''}
                                ${flight.airplane ? `<span>üõ©Ô∏è ${flight.airplane}</span>` : ''}
                                ${flight.is_overnight ? `<span style="color:#7c3aed;">üåô Overnight</span>` : ''}
                            </div>
                            <a href="${flight.booking_link}" target="_blank" class="book-btn" style="padding:10px 25px;">
                                Book Now ‚Üí
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function sortFlights(sortBy, btn) {
            document.querySelectorAll('#flightSortToggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            let sorted = [...window.allFlights];

            if (sortBy === 'price') {
                sorted.sort((a, b) => (a.price || 9999) - (b.price || 9999));
            } else if (sortBy === 'duration') {
                sorted.sort((a, b) => {
                    const durA = parseDuration(a.total_duration || a.outbound_duration);
                    const durB = parseDuration(b.total_duration || b.outbound_duration);
                    return durA - durB;
                });
            } else if (sortBy === 'departure') {
                sorted.sort((a, b) => {
                    const timeA = parseTime(a.outbound_departure_time);
                    const timeB = parseTime(b.outbound_departure_time);
                    return timeA - timeB;
                });
            }

            window.displayedFlights = sorted;
            displayFlights(sorted);
        }

        function filterFlightCount() {
            displayFlights(window.displayedFlights);
        }

        function parseDuration(duration) {
            if (!duration) return 9999;
            if (typeof duration === 'number') return duration;
            const match = duration.match(/(\d+)h?\s*(\d+)?m?/i);
            if (match) {
                const hours = parseInt(match[1]) || 0;
                const mins = parseInt(match[2]) || 0;
                return hours * 60 + mins;
            }
            return 9999;
        }

        function formatDuration(duration) {
            if (!duration) return null;
            if (typeof duration === 'string') return duration;
            if (typeof duration === 'number') {
                const hours = Math.floor(duration / 60);
                const mins = duration % 60;
                if (hours > 0 && mins > 0) return `${hours}h ${mins}m`;
                if (hours > 0) return `${hours}h`;
                return `${mins}m`;
            }
            return null;
        }

        function parseTime(time) {
            if (!time) return 9999;
            const match = time.match(/(\d+):(\d+)/);
            if (match) {
                return parseInt(match[1]) * 60 + parseInt(match[2]);
            }
            return 9999;
        }

        function showRestaurantTab(tab, btn) {
            // Update button states
            document.querySelectorAll('#restaurantTabs .tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            // Hide all tabs
            document.getElementById('mealsTab').style.display = 'none';
            document.getElementById('streetTab').style.display = 'none';
            document.getElementById('cafesTab').style.display = 'none';

            // Show selected tab
            if (tab === 'meals') {
                document.getElementById('mealsTab').style.display = 'block';
            } else if (tab === 'street') {
                document.getElementById('streetTab').style.display = 'block';
            } else if (tab === 'cafes') {
                document.getElementById('cafesTab').style.display = 'block';
            }
        }

        // Nightlife display and filtering
        function displayNightlife(nightlife) {
            window.allNightlife = nightlife || [];
            renderNightlife(window.allNightlife);
        }

        function renderNightlife(venues) {
            const container = document.getElementById('nightlifeList');

            if (!venues || venues.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:white;">
                        <div style="font-size:48px;margin-bottom:15px;">üåô</div>
                        <p>No nightlife venues found for this destination.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = venues.map(venue => `
                <div class="nightlife-card" data-music="${(venue.music_types || []).join(',').toLowerCase()}">
                    <div class="nightlife-header">
                        <div class="nightlife-name">${venue.name}</div>
                        <div class="nightlife-type">${venue.venue_type || 'Club'}</div>
                    </div>
                    <div class="nightlife-content">
                        <div class="music-tags">
                            ${(venue.music_types || ['Mixed']).map((m, i) => `
                                <span class="music-tag ${i === 0 ? 'primary' : ''}">${m}</span>
                            `).join('')}
                        </div>
                        <div class="nightlife-details">
                            <p>${venue.description || ''}</p>
                            ${venue.best_nights ? `<p style="margin-top:8px;"><strong>üî• Best nights:</strong> ${venue.best_nights}</p>` : ''}
                            ${venue.dress_code ? `<p><strong>üëî Dress code:</strong> ${venue.dress_code}</p>` : ''}
                            ${venue.age_restriction ? `<p><strong>üéÇ Age:</strong> ${venue.age_restriction}</p>` : ''}
                        </div>
                    </div>
                    <div class="nightlife-footer">
                        <div class="nightlife-price">
                            ${venue.entry_fee ? `Entry: ¬£${venue.entry_fee}` : 'Free entry'}
                            ${venue.drink_prices ? ` ¬∑ Drinks: ¬£${venue.drink_prices}` : ''}
                        </div>
                        <div class="nightlife-rating">
                            ${venue.rating ? `‚≠ê ${venue.rating}` : ''}
                        </div>
                    </div>
                    ${venue.neighborhood ? `
                        <div style="padding:10px 20px;background:rgba(255,255,255,0.1);font-size:12px;">
                            üìç ${venue.neighborhood} ${venue.opening_hours ? `¬∑ ${venue.opening_hours}` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function filterNightlife(musicType, btn) {
            // Update button states
            document.querySelectorAll('#musicFilter button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (musicType === 'all') {
                renderNightlife(window.allNightlife);
                return;
            }

            const filtered = window.allNightlife.filter(venue => {
                const types = (venue.music_types || []).map(t => t.toLowerCase());
                const searchTerm = musicType.toLowerCase();

                // Match music type keywords
                return types.some(t =>
                    t.includes(searchTerm) ||
                    (searchTerm === 'electronic' && (t.includes('house') || t.includes('edm') || t.includes('electronic'))) ||
                    (searchTerm === 'techno' && (t.includes('techno') || t.includes('industrial'))) ||
                    (searchTerm === 'hiphop' && (t.includes('hip') || t.includes('r&b') || t.includes('rap'))) ||
                    (searchTerm === 'latin' && (t.includes('latin') || t.includes('reggaeton') || t.includes('salsa'))) ||
                    (searchTerm === 'rock' && (t.includes('rock') || t.includes('indie') || t.includes('alternative'))) ||
                    (searchTerm === 'jazz' && (t.includes('jazz') || t.includes('blues') || t.includes('soul'))) ||
                    (searchTerm === 'mixed' && (t.includes('mixed') || t.includes('commercial') || t.includes('top 40'))) ||
                    (searchTerm === 'rooftop' && (t.includes('lounge') || t.includes('rooftop') || t.includes('chill')))
                );
            });

            renderNightlife(filtered);
        }
    </script>
</body>
</html>
